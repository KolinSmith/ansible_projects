#!/bin/bash
# Custom MOTD System Information
# Generated by Ansible - install_custom_motd role

# Colors
GREEN='{{ motd_color_good }}'
YELLOW='{{ motd_color_warning }}'
RED='{{ motd_color_critical }}'
CYAN='{{ motd_color_info }}'
NC='{{ motd_color_reset }}'

# Temperature thresholds
TEMP_WARN={{ motd_cpu_temp_warning }}
TEMP_CRIT={{ motd_cpu_temp_critical }}

# Helper function to colorize based on percentage
colorize_percent() {
    local value=$1
    local warn=${2:-70}
    local crit=${3:-90}

    if [ "$value" -ge "$crit" ]; then
        echo -e "${RED}${value}%${NC}"
    elif [ "$value" -ge "$warn" ]; then
        echo -e "${YELLOW}${value}%${NC}"
    else
        echo -e "${GREEN}${value}%${NC}"
    fi
}

# Helper function to colorize temperature
colorize_temp() {
    local temp=$1

    if [ "$temp" -ge "$TEMP_CRIT" ]; then
        echo -e "${RED}${temp}°C${NC}"
    elif [ "$temp" -ge "$TEMP_WARN" ]; then
        echo -e "${YELLOW}${temp}°C${NC}"
    else
        echo -e "${GREEN}${temp}°C${NC}"
    fi
}

echo -e "${CYAN}Performance:${NC}"
echo ""

{% if motd_show_load %}
# Load average
LOAD=$(cat /proc/loadavg | awk '{print $1}')
CORES=$(nproc)
LOAD_PERCENT=$(awk "BEGIN {printf \"%.0f\", ($LOAD / $CORES) * 100}")
echo -e " Load:         $(colorize_percent $LOAD_PERCENT 70 100) (${LOAD} on ${CORES} cores)"
{% endif %}

{% if motd_show_uptime %}
# Uptime
UPTIME=$(uptime -p | sed 's/up //')
echo -e " Uptime:       ${GREEN}${UPTIME}${NC}"
{% endif %}

{% if motd_show_memory %}
# Memory usage
MEM_USED=$(free | awk 'NR==2{printf "%.0f", $3*100/$2 }')
MEM_TOTAL=$(free -h | awk 'NR==2{print $2}')
MEM_USED_HR=$(free -h | awk 'NR==2{print $3}')
echo -e " Memory:       $(colorize_percent $MEM_USED) (${MEM_USED_HR} / ${MEM_TOTAL})"

# Swap usage if swap exists
SWAP_TOTAL=$(free -h | awk 'NR==3{print $2}')
if [ "$SWAP_TOTAL" != "0B" ]; then
    SWAP_USED=$(free | awk 'NR==3{printf "%.0f", $3*100/$2 }')
    SWAP_USED_HR=$(free -h | awk 'NR==3{print $3}')
    [ -n "$SWAP_USED" ] && [ "$SWAP_USED" != "0" ] && echo -e " Swap:         $(colorize_percent $SWAP_USED) (${SWAP_USED_HR} / ${SWAP_TOTAL})"
fi
{% endif %}

{% if motd_show_cpu_temp %}
# CPU Temperature
TEMP=""
# Try various temperature sources
if [ -f /sys/class/thermal/thermal_zone0/temp ]; then
    TEMP=$(cat /sys/class/thermal/thermal_zone0/temp 2>/dev/null)
    TEMP=$((TEMP/1000))
elif command -v sensors &> /dev/null; then
    # Try to get CPU package temp
    TEMP=$(sensors 2>/dev/null | grep -i "Package id 0:" | awk '{print $4}' | sed 's/+//;s/°C//' | cut -d'.' -f1)
    # If no package temp, try Tctl or other CPU temp
    if [ -z "$TEMP" ]; then
        TEMP=$(sensors 2>/dev/null | grep -i "Tctl:" | awk '{print $2}' | sed 's/+//;s/°C//' | cut -d'.' -f1)
    fi
    # Fallback to any Core temp
    if [ -z "$TEMP" ]; then
        TEMP=$(sensors 2>/dev/null | grep -i "Core 0:" | awk '{print $3}' | sed 's/+//;s/°C//' | cut -d'.' -f1)
    fi
fi

if [ -n "$TEMP" ] && [ "$TEMP" -gt 0 ]; then
    echo -e " CPU temp:     $(colorize_temp $TEMP)"
fi
{% endif %}

{% if motd_show_disk_usage %}
# Disk usage
ROOT_USAGE=$(df -h / | awk 'NR==2{print $(NF-1)}' | sed 's/%//')
ROOT_TOTAL=$(df -h / | awk 'NR==2{print $2}')
ROOT_USED=$(df -h / | awk 'NR==2{print $3}')
echo -e " Disk (/):     $(colorize_percent $ROOT_USAGE) (${ROOT_USED} / ${ROOT_TOTAL})"
{% endif %}

{% if motd_show_ip_addresses %}
# IP Addresses
echo ""
echo -e "${CYAN}Network:${NC}"
# Get primary interface IP (skip docker, virtual, etc)
PRIMARY_IP=$(ip -4 addr show | grep -v "127.0.0.1" | grep -v "docker" | grep -v "veth" | grep "inet " | head -1 | awk '{print $2}' | cut -d'/' -f1)
PRIMARY_IF=$(ip -4 addr show | grep -v "127.0.0.1" | grep -v "docker" | grep -v "veth" | grep "inet " | head -1 | awk '{print $NF}')
if [ -n "$PRIMARY_IP" ]; then
    echo -e " LAN IP:       ${GREEN}${PRIMARY_IP}${NC} (${PRIMARY_IF})"
fi

# Get public IP (optional, can be slow)
# PUBLIC_IP=$(curl -s -4 icanhazip.com 2>/dev/null || echo "N/A")
# [ "$PUBLIC_IP" != "N/A" ] && echo -e " Public IP:    ${GREEN}${PUBLIC_IP}${NC}"
{% endif %}

echo ""
