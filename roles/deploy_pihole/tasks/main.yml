---
  # - name: add SSH public key for borg so it can login to make backups
  #   authorized_key:
  #       user: "{{ user }}"
  #       key: "ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBOax0ZYUe5CpSHS+h4dPYEOpZs/aUbUol5b4ypwPV9jEdNsBUateQhzwtSXZJbosW4VpGIBtfQVhFgaJri2Fftc= root@Borg"
  #       state: present
  #       manage_dir: yes


  # - name: add SSH public key for local user
  #   # authorized_key:
  #   #     user: "{{ user }}"
  #   #     key: "{{ lookup('file', '/home/dax/.ssh/id_ecdsa.pub') }}"
  #   #     state: present
  #   #     manage_dir: yes
  #   authorized_key:
  #       user: "{{ user }}"
  #       state: present
  #       key: "{{ item.key }}"
  #       manage_dir: yes
  #   with_items:
  #     - "{{ public_keys }}"

  - name: create pihole group
    group:
      name: pihole
      state: present

  - name: create pihole user
    user:
      name: pihole
      group: pihole

  - name: create pihole folder
    file:
      path: /etc/pihole
      state: directory
      mode: 0644
      owner: pihole
      group: pihole

  - name: add pihole config file setupVars.conf file to /etc/pihole
    #https://web.archive.org/web/20230102233129/https://www.tecmint.com/install-rsyslog-centralized-logging-in-centos-ubuntu/
    template:
      src: /home/dax/code_base/ansible_projects/templates/pihole_setup_vars.j2
      dest: /etc/pihole/setupVars.conf
      owner: pihole #replaced root with this so that the pihole user could access the database file
      group: pihole
      mode: 0600

  - name: install pihole
    shell: curl -L https://install.pi-hole.net | bash /dev/stdin --unattended
    become: true

  # - name: add "{{ user }}" to /etc/pihole so it has access to the database file
  #   user: 
  #     name: "{{ user }}"
  #     groups: "pihole"
  #     append: yes               # Set to 'yes' to append the user to the group (if the group exists), or 'no' to replace the user's group memberships

  - name: touch dnsmasq file to setup wildcard DNS
    file:
      path: /etc/dnsmasq.d/02-my-wildcard-dns.conf
      state: touch
      mode: 0644

  - name: add dnsmasq.d file
    lineinfile:
      dest: /etc/dnsmasq.d/02-my-wildcard-dns.conf
      state: present
      mode: 0644
      line: |
        address=/internal.homelab.gg/{{ hostvars[groups['dev_server'][0]]['ansible_host'] }} 
        address=/pfsense.internal.homelab.gg/{{ hostvars[groups['dev_server'][0]]['ansible_host'] }}
        address=/discovery.internal.homelab.gg/192.168.9.9
        address=/borg.internal.homelab.gg/192.168.9.7

    #pihole -w dartsearch.net googleadservices.com www.dartsearch.net www.googleadservices.com clickserve.dartsearch.net ad.doubleclick.net
        
  - name: Update, Upgrade, & Clean
    tags: always
    apt:
      upgrade: yes
      update_cache: yes
      cache_valid_time: "86400"
      autoremove: yes
      autoclean: yes
    ignore_errors: true
