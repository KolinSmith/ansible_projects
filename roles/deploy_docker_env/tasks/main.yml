---
# Create target directories on remote host
- name: Create docker directory
  file:
    path: "/home/{{ ansible_user }}/docker"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

- name: Create docker_data directory
  file:
    path: "/home/{{ ansible_user }}/docker_data"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

# Copy only this service's files from the controller's docker_projects repo
- name: Copy service files for {{ deploy_docker_services_for }}
  copy:
    src: "{{ docker_projects_base_path }}/{{ deploy_docker_services_for }}/"
    dest: "/home/{{ ansible_user }}/docker/"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'

# Deploy .env from vault-populated template (runs after copy so it is never
# overwritten by a stale .env from the controller)
- name: Deploy .env for {{ deploy_docker_services_for }}
  template:
    src: "{{ deploy_docker_services_for }}.env.example"
    dest: "/home/{{ ansible_user }}/docker/.env"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0600'

# Service-specific configuration
- name: Create status alias for Dockerized Tor relay monitoring (operator only)
  lineinfile:
    path: "/home/{{ ansible_user }}/.zshrc"
    line: "alias status='docker exec -it tor-relay nyx'"
    regexp: "^alias status="
    state: present
    create: yes
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'
  when: deploy_docker_services_for == 'operator'
